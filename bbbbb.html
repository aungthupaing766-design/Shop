<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <title>POS á€…á€”á€…á€º - á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#52B788">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <style>
        /* ==================== Global & Theme Settings ==================== */
        :root {
          /* Light Theme (Default) */
          --primary: #52B788; /* Green for POS system */
          --secondary: #35795C;
          --accent: #E8F5E9;
          --background: #f5f5f5;
          --surface: #ffffff;
          --text: #333;
          --text-light: #666;
          --border: #e0e0e0;
          --input-bg: #f9f9f9;
          --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
          --shadow-md: 0 4px 10px rgba(0,0,0,0.15);
          --danger: #C62828;
          --success: #2E7D32;
          --info: #0277bd;
          --dark-nav: #264653;
          --nav-text: white;
    
          /* Custom Cart Summary UI/UX (Based on 1000008464.jpg) */
          --cart-summary-bg: #f9f4e8; /* Light beige background */
          --cart-summary-text: #4a4a4a;
          --cart-summary-border: #d3ccc0;
          --cart-summary-total-color: #333;
          --cart-summary-line: #d3ccc0;
          --warning: #FFC107; /* Added for stock alert */
        }
    
        /* Dark Theme Styles */
        body.dark-theme {
            --primary: #80CBC4;
            --secondary: #4DB6AC;
            --accent: #1D5C63;
            --background: #121212;
            --surface: #1E1E1E;
            --text: #E0E0E0;
            --text-light: #B0B0B0;
            --border: #333;
            --input-bg: #282828;
            --dark-nav: #000000;
            --nav-text: #80CBC4;
            
            /* Dark Cart UI Colors */
            --cart-summary-bg: #2b2b2b; 
            --cart-summary-text: #E0E0E0;
            --cart-summary-border: #444;
            --cart-summary-total-color: #EEEEEE;
            --cart-summary-line: #444;
            --warning: #FFD54F;
        }
        
        body {
          font-family: 'Noto Sans Myanmar', sans-serif;
          margin: 0;
          padding: 0;
          background-color: var(--background);
          color: var(--text);
          line-height: 1.5;
          font-size: 15px;
          transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
          display: flex;
          flex-direction: column;
          min-height: 100vh;
          width: 100%;
        }
    
        /* Tab Navigation */
        .nav-tabs { 
            display: flex; 
            background-color: var(--dark-nav); 
            color: var(--nav-text); 
            box-shadow: var(--shadow-md); 
            position: relative; 
        }
        .nav-tab { 
            padding: 15px 20px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.3s, color 0.3s; 
            border-right: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .nav-tab.active { background-color: var(--primary); color: var(--surface); }
        
        /* Cart Icon and Counter in Navigation */
        .cart-nav-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: var(--nav-text);
            cursor: pointer;
        }
    
        .cart-count {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: var(--danger); /* Red badge */
            color: white;
            border-radius: 50%;
            padding: 2px 7px;
            font-size: 12px;
            line-height: 1;
            font-weight: bold;
            display: none; /* Initially hidden */
            min-width: 12px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        
        .content-area { display: flex; flex-grow: 1; padding: 20px; background-color: var(--surface); transition: background-color 0.3s; }
        .tab-content { display: none; width: 100%; }
        .tab-content.active { display: block; }
        
        /* Buttons and Controls (Improved) */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 15px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-add-new { background: var(--success); color: var(--surface); }
        .btn-save { background: var(--secondary); color: var(--surface); }
        .btn-print { background: var(--info); color: var(--surface); }
        .btn-danger { background: var(--danger); color: var(--surface); }
        .btn-clear { background: var(--danger); color: var(--surface); }
        .btn-quick-cash { background: var(--accent); color: var(--text); padding: 8px 12px; font-size: 14px; } /* New Quick Cash style */
        .btn-quick-cash:hover { background: var(--primary); color: var(--surface); }
        .action-icon { background: none; border: none; cursor: pointer; font-size: 18px; margin: 0 5px; transition: color 0.2s; color: var(--text-light); }
        .action-icon:hover { color: var(--primary); }
    
        /* Forms and Inputs */
        .controls-group { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .controls-group label { font-weight: bold; color: var(--text-light); white-space: nowrap; }
        .controls-group input, .controls-group select, .form-input, .form-select, .form-textarea { 
            padding: 10px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            font-family: inherit; 
            transition: border-color 0.2s, background-color 0.3s; 
            background-color: var(--input-bg);
            color: var(--text);
            box-sizing: border-box;
        }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text); }
        .form-input, .form-select, .form-textarea { width: 100%; }
        .form-textarea { resize: vertical; }
    
        /* ==================== POS Layout (REVISED CART WIDTH) ==================== */
        .pos-layout { display: flex; width: 100%; gap: 20px; position: relative; }
        .pos-product-list { flex: 3; display: flex; flex-direction: column; }
        /* Sales Cart á€€á€­á€¯ á€¡á€œá€»á€¬á€¸ á€€á€»á€‰á€ºá€¸á€•á€±á€¸á€‘á€¬á€¸á€á€Šá€º */
        .pos-cart-section { 
            flex: 1.2; /* á€•á€­á€¯á€•á€¼á€®á€¸á€€á€»á€‰á€ºá€¸á€¡á€±á€¬á€„á€ºá€œá€¯á€•á€ºá€‘á€¬á€¸á€á€Šá€º */
            min-width: 280px; /* á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ width á€€á€­á€¯ 280px á€á€­á€¯á€· á€•á€¼á€±á€¬á€„á€ºá€¸á€‘á€¬á€¸á€á€Šá€º */
            padding: 15px; 
            background-color: var(--surface); 
            border-radius: 8px; 
            box-shadow: var(--shadow-md); 
            position: relative; 
        }
        
        /* Enhanced Product Grid UI/UX - Improved Card Design */
        .product-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; 
            overflow-y: auto; 
            padding-right: 5px; 
            flex-grow: 1; 
            max-height: 80vh; 
        }
        .product-item {
            background: var(--surface);
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); /* Enhanced shadow */
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 0;
            border: 1px solid var(--border);
            height: 180px; /* Fixed height for consistency */
        }
        .product-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }
        .product-item img {
            width: 100%; 
            height: 100px; /* Slightly larger image area */
            object-fit: cover;
            border-radius: 11px 11px 0 0;
            margin-bottom: 0;
        }
        .product-item.no-image .product-name { margin-top: 10px; } 
        .product-item.no-image { padding-top: 10px; } 
    
        .product-info {
            padding: 10px 12px 40px 12px; /* More padding for better spacing */
            width: 100%;
            box-sizing: border-box;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-name {
            font-weight: bold;
            color: var(--text);
            font-size: 14px;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 2 lines max */
            -webkit-box-orient: vertical;
            line-height: 1.2;
            height: 2.4em; /* For 2 lines of text */
            margin-bottom: 5px;
        }
        /* Enhanced Price Tag */
        .product-price {
            position: absolute;
            bottom: 10px;
            left: 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-size: 14px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Enhanced Cart Items with Drag & Drop - Smaller and without Images */
        .cart-items { 
          max-height: 35vh; 
          overflow-y: auto; 
          margin-bottom: 15px; 
          background: var(--input-bg); 
          border-radius: 6px; 
          padding: 5px; 
          border: 1px solid var(--border);
          min-height: 50px;
        }
        
        /* Cart Item Row - Smaller without Images */
        .cart-item { 
            display: flex; 
            align-items: center; 
            padding: 8px 5px; /* Reduced padding */
            border-bottom: 1px dotted var(--cart-summary-line);
            font-size: 12px; /* Smaller font */
            transition: all 0.2s ease;
            background-color: var(--surface);
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: grab;
            position: relative;
        }
        .cart-item:hover {
            background-color: var(--accent);
            transform: translateX(3px);
        }
        .cart-item:last-child { border-bottom: none; margin-bottom: 0; }
        .cart-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .cart-item.drag-over {
            border-top: 2px solid var(--primary);
        }
        
        .cart-item-details { 
            flex: 1; 
            margin-right: 5px; 
            overflow: hidden; 
            min-width: 0; /* Prevent overflow */
        }
        .cart-item-name { 
            font-weight: bold; 
            color: var(--text); 
            font-size: 12px; /* Smaller font */
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .cart-item-price-qnty { 
            font-size: 10px; 
            color: var(--text-light); 
            display: block; 
            margin-top: 2px;
        } 
        /* Quantity Controls - Smaller */
        .qty-controls { 
            display: flex; 
            align-items: center; 
            gap: 3px; /* Smaller gap */
            width: 75px; /* Smaller width */
            justify-content: space-between; 
            flex-shrink: 0; 
            background: var(--surface);
            border-radius: 4px;
            border: 1px solid var(--border);
            padding: 1px 0;
        }
        .qty-btn { 
            width: 18px; /* Smaller buttons */
            height: 18px; 
            border-radius: 3px; 
            font-size: 12px; /* Smaller font */
            background: none;
            color: var(--primary);
            border: none; 
            cursor: pointer; 
            padding: 0; 
            line-height: 1; 
            font-weight: bold;
            flex-shrink: 0;
            transition: color 0.1s;
        }
        .qty-btn:hover {
            color: var(--secondary);
        }
        .item-qty { 
            font-weight: bold; 
            font-size: 12px; /* Smaller font */
            color: var(--text);
            flex-grow: 1;
            text-align: center; 
        }
        /* Item Total - Smaller */
        .cart-item-total { 
            width: 55px; /* Smaller width */
            text-align: right; 
            font-weight: bold; 
            color: var(--danger); 
            font-size: 12px; /* Smaller font */
            flex-shrink: 0; 
        }
        
        /* Enhanced Delete Icon - Smaller */
        .cart-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px; /* Smaller icon */
            color: var(--danger);
            margin-left: 3px;
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
            transition: opacity 0.2s;
        }
        .cart-delete-btn:hover {
            opacity: 0.7;
        }

        /* Drag Handle for Cart Items - Smaller */
        .drag-handle {
            cursor: grab;
            color: var(--text-light);
            margin-right: 5px;
            font-size: 12px; /* Smaller font */
            transition: color 0.2s;
        }
        .drag-handle:hover {
            color: var(--primary);
        }

        .action-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .action-buttons .btn { flex-grow: 1; padding: 12px 10px; font-size: 15px; }
    
        /* **Cart Summary UI/UX (Based on 1000008464.jpg)** */
        .cart-summary {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--cart-summary-bg); 
            border-radius: 8px;
            border: 1px solid var(--cart-summary-border);
            color: var(--cart-summary-text);
            font-size: 16px;
            box-shadow: var(--shadow-sm);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dotted var(--cart-summary-line);
        }
        
        .summary-row.total-separator {
            border-bottom: 1px solid var(--cart-summary-line); 
            margin-bottom: 5px;
            padding-bottom: 10px;
        }
        
        .summary-row:last-of-type { border-bottom: none; }
        
        .summary-row span:first-child { font-weight: normal; font-size: 15px; }
        .summary-row span:last-child { font-weight: normal; font-size: 15px; }
    
        .total-row {
            font-weight: bold;
            font-size: 20px;
            padding: 8px 0;
            margin-top: 5px;
            border-bottom: 1px solid var(--cart-summary-line);
        }
        .total-row span {
            font-weight: bold !important;
            font-size: 20px !important;
            color: var(--cart-summary-total-color);
        }
    
        .cash-row, .change-row {
            font-size: 16px;
            padding: 6px 0;
        }
        .cash-row span:last-child, .change-row span:last-child {
            font-weight: bold;
            font-size: 18px;
            color: var(--secondary);
        }
        
        /* Quick Cash Buttons style */
        .quick-cash-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: space-between;
        }
    
        /* Discount & Cash Input styles */
        .input-group-controls { display: flex; gap: 10px; padding: 10px 0; border-top: 1px solid var(--border); align-items: center; margin-bottom: 15px; }
        .input-group-controls > div { flex: 1; }
        .input-group-field { display: flex; align-items: center; }
        .input-group-field input { 
            flex-grow: 1; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--border); 
            background-color: var(--input-bg); 
            color: var(--text); 
            font-size: 16px; 
            text-align: right; 
        }
        .input-group-field span { margin-left: 8px; font-weight: bold; color: var(--text-light); }
    
        /* ==================== Central Calculator Styles ==================== */
        .calculator-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .calculator-modal.active {
            display: flex;
            opacity: 1;
        }
        .calculator-container {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 400px;
            padding: 20px;
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        .calculator-modal.active .calculator-container {
            transform: translateY(0);
        }
        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .calculator-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }
        .calculator-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s;
        }
        .calculator-close:hover {
            color: var(--danger);
        }
        .calculator-display {
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            font-size: 24px;
            font-weight: bold;
            text-align: right;
            color: var(--text);
            margin-bottom: 15px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .calculator-total-display {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        .calculator-value-display {
            font-size: 24px;
            color: var(--text);
            word-break: break-all;
        }
        .calculator-buttons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .calculator-btn {
            padding: 15px 5px;
            border: none;
            border-radius: 8px;
            background-color: var(--accent);
            color: var(--text);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calculator-btn:hover {
            background-color: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        .calculator-btn.action {
            background-color: var(--info);
            color: white;
        }
        .calculator-btn.action.clear {
            background-color: var(--danger);
        }
        .calculator-btn.action.apply {
            background-color: var(--success);
        }

        /* ==================== Dashboard Cards & Table ==================== */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--surface); padding: 20px; border-radius: 10px; box-shadow: var(--shadow-md); border-left: 5px solid var(--primary); transition: all 0.3s; }
        .card-title { font-size: 14px; color: var(--text-light); margin-bottom: 10px; }
        .card-value { font-size: 30px; font-weight: bold; color: var(--text); }
        
        /* Reports/Dashboard Table */
        .reports-table { width: 100%; border-collapse: collapse; margin-top: 10px; box-shadow: var(--shadow-sm); }
        .reports-table th, .reports-table td { border: 1px solid var(--border); padding: 10px; text-align: left; font-size: 14px; }
        .reports-table th { background-color: var(--accent); color: var(--text); }
        .reports-table tr:nth-child(even) { background-color: var(--input-bg); }
        .reports-summary { display: flex; justify-content: flex-end; gap: 30px; margin-top: 15px; font-size: 16px; font-weight: bold; padding: 10px 0; border-top: 2px solid var(--primary);}
        .reports-summary div { color: var(--danger); }
    
        /* ==================== Modal/Form UI/UX ==================== */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            padding-top: 50px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; }
        .modal-content {
            background-color: var(--surface);
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        .modal.active .modal-content { transform: translateY(0); }
        .modal-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px;}
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    
        /* Image Upload Section */
        .image-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
            margin-bottom: 15px;
        }
        .image-upload-area:hover { border-color: var(--primary); background-color: var(--input-bg); }
        .image-preview-container {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 6px;
        }
        .image-preview { max-width: 80px; max-height: 80px; border-radius: 4px; object-fit: cover; }
        .delete-image-btn { background: var(--danger); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 14px; cursor: pointer; transition: background-color 0.2s; }
        .delete-image-btn:hover { background: #991C1C; }
    
        /* ==================== Setting Table Click Item UI/UX Designer ==================== */
        .settings-form h3 { color: var(--primary); border-bottom: 1px solid var(--accent); padding-bottom: 5px; margin-top: 25px;}
    
        /* Style for Low Stock products in Management Table */
        .low-stock { background-color: var(--warning); color: var(--text); font-weight: bold; }
        .low-stock td { border-color: var(--warning) !important; }
    
        /* New CSS for Product Item (when image fails or is missing) */
        .product-item img.hidden { display: none !important; }
        .product-management-table img.hidden { display: none !important; }
        /* Ensure the table cell still looks fine when image is hidden */
        .product-management-table td:nth-child(2) { text-align: center; } 
        
        /* Toast/Message Popup Styles */
        #toast-message {
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            background-color: var(--success); 
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            z-index: 2000;
            opacity: 0; 
            visibility: hidden;
            transition: opacity 0.5s, visibility 0s linear 0.5s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        #toast-message.show {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s, visibility 0s linear 0s;
        }
        
        /* ==================== Number Pad Styles (Calculator Cart) ==================== */
        .number-pad-modal {
            position: absolute; 
            bottom: 100px; 
            right: 15px;
            z-index: 1100; 
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            padding: 10px;
            width: 250px;
            display: none;
            flex-direction: column;
            gap: 10px;
            transition: all 0.2s ease-in-out;
        }
        .number-pad-modal.active {
            display: flex;
        }
        .pad-display {
            background-color: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            font-size: 20px;
            font-weight: bold;
            text-align: right;
            color: var(--text);
            min-height: 40px;
        }
        .pad-buttons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        .pad-btn {
            padding: 15px 5px;
            border: none;
            border-radius: 5px;
            background-color: var(--accent);
            color: var(--text);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .pad-btn:hover {
            background-color: var(--primary);
            color: white;
        }
        .pad-btn.action {
            background-color: var(--info);
            color: white;
        }
        .pad-btn.action.clear {
            background-color: var(--danger);
        }
    
      </style>
</head>
<body class="light-theme">
<div class="container">
  <div class="nav-tabs">
    <div class="nav-tab active" data-tab="pos-section">ğŸ’° POS á€…á€”á€…á€º</div>
    <div class="nav-tab" data-tab="management-section">ğŸ“¦ á€•á€…á€¹á€…á€Šá€ºá€¸á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯</div>
    <div class="nav-tab" data-tab="dashboard-section">ğŸ“ˆ Dashboard</div>
    <div class="nav-tab" data-tab="reports-section">ğŸ§¾ á€¡á€›á€±á€¬á€„á€ºá€¸á€™á€¾á€á€ºá€á€™á€ºá€¸/Reports</div>
    <div class="nav-tab" data-tab="settings-section">âš™ï¸ Settings</div>
    
    <div class="cart-nav-icon" title="á€…á€»á€±á€¸á€á€¼á€„á€ºá€¸">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-count" id="navCartCount">0</span>
    </div>
    </div>

  <div class="content-area">
    
    <div class="tab-content active" id="pos-section">
      <div class="pos-layout">
        <div class="pos-product-list">
          <h3>á€•á€…á€¹á€…á€Šá€ºá€¸á€™á€»á€¬á€¸ (Products)</h3>
          
          <div class="controls-group">
              <select id="posCategoryFilter" onchange="renderPOSProducts()">
                   </select>
              <input type="text" id="posProductSearch" oninput="renderPOSProducts()" placeholder="á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€ºá€›á€¾á€¬á€›á€”á€º..." style="flex-grow: 1;">
          </div>

          <div class="product-grid" id="posProductGrid">
            </div>
        </div>
        
        <div class="pos-cart-section">
          <div class="cart-header">á€…á€»á€±á€¸á€á€¼á€„á€ºá€¸á€œá€¾á€Šá€ºá€¸ (Sales Cart)</div>
          
          <div class="cart-items" id="cartItems">
            <div class="empty-cart" style="text-align: center; color: var(--text-light); padding: 15px 0;">á€…á€»á€±á€¸á€á€šá€ºá€á€¼á€„á€ºá€¸á€™á€›á€¾á€­á€á€±á€¸á€•á€«</div>
          </div>
          <div class="input-group-controls" style="border-top: none; margin-bottom: 0;">
            <div class="discount-input">
                <label for="discount_percent" class="input-group-label" style="font-size: 18px; margin-top: 5px;">Discount (%):</label>
                <div class="input-group-field">
                    <input 
                        type="number" 
                        id="discount_percent" 
                        min="0" 
                        max="100" 
                        placeholder="0" 
                        style="padding: 10px;"
                        onfocus="openCalculator('discount_percent')"
                        onchange="calculateTotals()" 
                    >
                    <span>%</span>
                </div>
            </div>
          </div>

          <div class="cart-summary">
            <div class="summary-row">
              <span>Subtotal:</span>
              <span id="subtotal">0</span>
            </div>
            <div class="summary-row">
              <span>Discount:</span>
              <span id="discount-display">0</span>
            </div>
            <div class="summary-row total-row">
              <span>Total:</span>
              <span id="total">0</span>
            </div>
            <div class="cash-row summary-row">
                <span>Cash:</span>
                <span id="cash-display">0</span>
            </div>
            <div class="change-row summary-row">
                <span>Change:</span>
                <span id="change">0</span>
            </div>
          </div>
          <div class="input-group-controls" style="margin-top: 15px; border-top: 1px solid var(--border);">
            <div class="cash-input" style="flex: 1;">
                <label for="cash" class="input-group-label" style="font-size: 18px; margin-top: 5px;">á€•á€±á€¸á€„á€½á€± (Cash MMK):</label>
                <div class="input-group-field">
                    <button class="btn btn-quick-cash" onclick="openCalculator('cash')" title="á€‚á€á€”á€ºá€¸á€á€½á€€á€ºá€…á€€á€º á€–á€½á€„á€·á€ºá€™á€Šá€º" style="padding: 10px; width: 40px; height: 40px; flex-shrink: 0; margin-right: 5px;">
                        <i class="fas fa-calculator"></i>
                    </button>
                    <input 
                        type="number" 
                        id="cash" 
                        min="0" 
                        placeholder="0" 
                        style="padding: 10px;"
                        onfocus="openCalculator('cash')"
                        onchange="calculateTotals()"
                    >
                    <span>MMK</span>
                </div>
            </div>
          </div>
          
          <div class="quick-cash-buttons">
              <button class="btn btn-quick-cash" onclick="setCashAmount(5000)">5,000</button>
              <button class="btn btn-quick-cash" onclick="setCashAmount(10000)">10,000</button>
              <button class="btn btn-quick-cash" onclick="setCashAmount(20000)">20,000</button>
              <button class="btn btn-quick-cash" onclick="setCashAmount('auto')">Auto Round</button>
          </div>
          <div class="action-buttons">
            <button class="btn btn-clear" onclick="clearCart()">
              <span>âœ–ï¸ á€›á€¾á€„á€ºá€¸á€™á€Šá€º</span>
            </button>
            <button class="btn btn-save" onclick="saveOrder(false)">
              <span>ğŸ’¾ á€á€­á€™á€ºá€¸á€™á€Šá€º</span>
            </button>
            <button class="btn btn-print" onclick="printReceipt()">
              <span>ğŸ–¨ï¸ á€˜á€±á€¬á€„á€ºá€á€»á€¬á€‘á€¯á€á€º</span>
            </button>
          </div>

           <div class="number-pad-modal" id="numberPadModal">
                <div class="pad-display" id="padDisplay">0</div>
                <div class="pad-buttons-grid">
                    <button class="pad-btn" onclick="handleNumberPadInput('7')">7</button>
                    <button class="pad-btn" onclick="handleNumberPadInput('8')">8</button>
                    <button class="pad-btn" onclick="handleNumberPadInput('9')">9</button>
                    <button class="pad-btn action clear" onclick="handleNumberPadInput('clear')">C</button>
                    
                    <button class="pad-btn" onclick="handleNumberPadInput('4')">4</button>
                    <button class="pad-btn" onclick="handleNumberPadInput('5')">5</button>
                    <button class="pad-btn" onclick="handleNumberPadInput('6')">6</button>
                    <button class="pad-btn action" onclick="handleNumberPadInput('back')"><i class="fas fa-backspace"></i></button>

                    <button class="pad-btn" onclick="handleNumberPadInput('1')">1</button>
                    <button class="pad-btn" onclick="handleNumberPadInput('2')">2</button>
                    <button class="pad-btn" onclick="handleNumberPadInput('3')">3</button>
                    <button class="pad-btn action" onclick="handleNumberPadInput('apply')">OK</button>
                    
                    <button class="pad-btn" onclick="handleNumberPadInput('0')">0</button>
                    <button class="pad-btn" onclick="handleNumberPadInput('00')">00</button>
                    <button class="pad-btn" onclick="handleNumberPadInput('.')">.</button>
                    <button class="pad-btn action" onclick="openNumberPad(false)">âœ–ï¸</button>
                </div>
            </div>
            </div>
      </div>
    </div>
    
    <!-- Other tab contents remain the same -->
    <div class="tab-content" id="management-section">
      <div class="management-header controls-group" style="justify-content: space-between;">
        <h2>ğŸ“¦ á€•á€…á€¹á€…á€Šá€ºá€¸á€…á€¬á€›á€„á€ºá€¸á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯</h2>
        <div class="controls-group">
            <button class="btn btn-add-new" onclick="openProductModal()" style="flex-shrink: 0;">
                <span>+ á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€™á€Šá€º</span>
            </button>
            <button class="btn btn-print" onclick="exportProductTableToExcel()" style="flex-shrink: 0;">
                <span>ğŸ“Š Excel/CSV Download</span>
            </button>
        </div>
      </div>

      <div class="controls-group">
          <input type="text" class="search-box" placeholder="á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€ºá€›á€¾á€¬á€›á€”á€º..." id="managementSearchBox">
          <select class="filter-select" id="managementCategoryFilter" onchange="renderProductsTable()">
               </select>
      </div>
      
      <div style="flex-grow: 1; overflow-y: auto;">
          <table class="reports-table product-management-table">
            <thead>
              <tr>
                <th>á€…á€‰á€º</th> <th>á€“á€¬á€á€ºá€•á€¯á€¶</th>
                <th>á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€º</th>
                <th>á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸</th>
                <th>á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸</th>
                <th>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€›á€±á€¬á€„á€ºá€¸á€› Qty</th> <th>á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€á€»á€€á€º</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              </tbody>
          </table>
      </div>
    </div>

    <!-- Dashboard, Reports, and Settings sections remain the same -->
    <div class="tab-content" id="dashboard-section">
        <h2>ğŸ“ˆ Dashboard Overview</h2>
        
        <div class="controls-group" style="border: 1px solid var(--border); padding: 10px; border-radius: 6px;">
            <label>Start Date:</label>
            <input type="date" id="dashboardRangeStartDate">
            <label>End Date:</label>
            <input type="date" id="dashboardRangeEndDate">
            <button class="btn btn-info" onclick="renderDashboard()">
                <span>ğŸ” á€›á€€á€ºá€…á€½á€²á€–á€¼á€„á€·á€º á€€á€¼á€Šá€·á€ºá€™á€Šá€º</span>
            </button>
        </div>

        <div class="summary-cards">
            <div class="card" style="border-left-color: var(--success);">
                <div class="card-title">ğŸ“… **á€á€…á€ºá€”á€±á€· á€¡á€›á€±á€¬á€„á€ºá€¸ (Today's Sales)**</div>
                <div class="card-value" id="todayTotalSales">0</div> </div>
            <div class="card" style="border-left-color: var(--info);">
                <div class="card-title">ğŸ’µ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€¡á€›á€±á€¬á€„á€ºá€¸ (Range)</div>
                <div class="card-value" id="dailyTotalSales">0</div>
            </div>
            <div class="card" style="border-left-color: var(--danger);">
                <div class="card-title">ğŸ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ Discount (Range)</div>
                <div class="card-value" id="dailyTotalDiscount">0</div>
            </div>
            <div class="card" style="border-left-color: var(--accent);">
                <div class="card-title">ğŸ“¦ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ Qty (Range)</div>
                <div class="card-value" id="dailyTotalQuantity">0 á€á€¯</div>
            </div>
            <div class="card" style="border-left-color: var(--danger);">
                <div class="card-title">ğŸ§¾ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€˜á€±á€¬á€„á€ºá€á€»á€¬ (Range)</div>
                <div class="card-value" id="dailyTotalReceipts">0 á€á€¯</div>
            </div>
        </div>

        <h3>á€•á€…á€¹á€…á€Šá€ºá€¸á€›á€±á€¬á€„á€ºá€¸á€¡á€¬á€¸ á€¡á€€á€»á€‰á€ºá€¸á€á€»á€¯á€•á€º (Product Sales Summary)</h3>
        <div class="controls-group">
            <input type="text" id="dashboardProductNameSearch" oninput="renderDashboardProductSummary()" placeholder="á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€ºá€›á€¾á€¬á€›á€”á€º" style="flex-grow: 1;">
            <button class="btn btn-print" onclick="exportDashboardSummaryToExcel()">
                <span>ğŸ“Š Excel Download</span>
            </button>
        </div>

        <div style="overflow-x: auto;">
            <table class="reports-table">
                <thead>
                    <tr>
                        <th>á€›á€€á€ºá€…á€½á€² (á€•á€‘á€™á€›á€±á€¬á€„á€ºá€¸á€›á€€á€º)</th>
                        <th>á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€º</th>
                        <th>á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸/á€á€á€¯</th>
                        <th>Qty á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</th>
                        <th>Total á€á€„á€ºá€„á€½á€±</th>
                    </tr>
                </thead>
                <tbody id="dashboardProductSummaryTable">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="tab-content" id="reports-section">
        <h2>ğŸ§¾ á€¡á€›á€±á€¬á€„á€ºá€¸á€™á€¾á€á€ºá€á€™á€ºá€¸ (Reports)</h2>
        
        <div class="controls-group" style="border: 1px solid var(--border); padding: 10px; border-radius: 6px;">
            <label>Start Date:</label>
            <input type="date" id="reportStartDate">
            <label>End Date:</label>
            <input type="date" id="reportEndDate">
            <button class="btn btn-add-new" onclick="renderReportsTable()">
                <span>ğŸ” á€›á€€á€ºá€…á€½á€²á€–á€¼á€„á€·á€º á€€á€¼á€Šá€·á€ºá€™á€Šá€º</span>
            </button>
            <button class="btn btn-print" onclick="exportReportsToExcel()">
                <span>ğŸ“Š Excel Download</span>
            </button>
        </div>

        <div class="controls-group" style="margin-top: 10px;">
            <input type="text" id="reportProductNameSearch" placeholder="á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€º á€á€­á€¯á€· á€˜á€±á€¬á€„á€ºá€á€»á€¬ ID á€›á€¾á€¬á€›á€”á€º" oninput="renderReportsTable()" style="flex-grow: 1;">
            <button class="btn btn-danger" onclick="deleteSalesByDate()">
                <span>ğŸ—‘ï¸ á€™á€¾á€á€ºá€á€™á€ºá€¸á€–á€»á€€á€ºá€™á€Šá€º</span>
            </button>
        </div>

        <div style="overflow-x: auto;">
            <table class="reports-table">
                <thead>
                    <tr>
                        <th>á€›á€€á€ºá€…á€½á€²/á€¡á€á€»á€­á€”á€º</th>
                        <th>á€˜á€±á€¬á€„á€ºá€á€»á€¬ ID</th>
                        <th>á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€º</th>
                        <th>á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸/á€á€á€¯</th>
                        <th>Qty</th>
                        <th>Total (Item)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    </tbody>
            </table>
        </div>

        <div class="reports-summary">
            <div>**Qty á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:** <span id="reportTotalQty">0</span> á€á€¯</div>
            <div>**Total á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:** <span id="reportTotalSales">0</span></div>
        </div>
    </div>
    
    <div class="tab-content" id="settings-section">
        <h2>âš™ï¸ Settings - á€†á€­á€¯á€„á€ºá€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€”á€¾á€„á€ºá€· á€…á€”á€…á€ºá€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯</h2>
        
        <div class="settings-form">
            
            <h3>Theme á€›á€½á€±á€¸á€á€»á€šá€ºá€™á€¾á€¯</h3>
            <div class="form-group">
                <label for="themeSelect" class="form-label">á€…á€”á€…á€ºá á€¡á€á€½á€„á€ºá€¡á€•á€¼á€„á€º (Theme):</label>
                <select id="themeSelect" class="form-select" onchange="switchTheme(this.value)">
                    <option value="light">Light Theme (á€¡á€œá€„á€ºá€¸)</option>
                    <option value="dark">Dark Theme (á€¡á€™á€¾á€±á€¬á€„á€º)</option>
                </select>
            </div>
            
            <h3>á€˜á€±á€¬á€„á€ºá€á€»á€¬ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸</h3>
            <div class="form-group">
                <label for="shopName" class="form-label">á€†á€­á€¯á€„á€ºá€¡á€™á€Šá€º:</label>
                <input type="text" id="shopName" class="form-input" placeholder="á€¥á€•á€™á€¬: My Coffee Shop">
            </div>
            <div class="form-group">
                <label for="shopAddress" class="form-label">á€†á€­á€¯á€„á€ºá€œá€­á€•á€ºá€…á€¬:</label>
                <input type="text" id="shopAddress" class="form-input" placeholder="á€¥á€•á€™á€¬: á€œá€™á€ºá€¸á€™á€á€±á€¬á€ºá€œá€™á€ºá€¸áŠ á€›á€”á€ºá€€á€¯á€”á€º">
            </div>
            <div class="form-group">
                <label for="shopPhone" class="form-label">á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º:</label>
                <input type="text" id="shopPhone" class="form-input" placeholder="á€¥á€•á€™á€¬: 09-123456789">
            </div>
            <div class="form-group">
                <label for="receiptThankYou" class="form-label">á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€…á€€á€¬á€¸ (á€˜á€±á€¬á€„á€ºá€á€»á€¬á€¡á€±á€¬á€€á€ºá€†á€¯á€¶á€¸):</label>
                <textarea id="receiptThankYou" rows="2" class="form-textarea" placeholder="á€¥á€•á€™á€¬: á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€šá€ºáŠ á€”á€±á€¬á€€á€ºá€™á€¾á€•á€¼á€”á€ºá€œá€¬á€á€²á€·á€•á€«á€¦á€¸á‹"></textarea>
            </div>
            <div class="form-group">
                <label for="receiptSize" class="form-label">á€˜á€±á€¬á€„á€ºá€á€»á€¬ á€…á€¬á€›á€½á€€á€º á€¡á€›á€½á€šá€ºá€¡á€…á€¬á€¸:</label>
                <select id="receiptSize" class="form-select">
                    <option value="80mm">80mm (á€•á€›á€„á€·á€ºá€á€¬á€¡á€€á€¼á€®á€¸)</option>
                    <option value="58mm">58mm (á€•á€›á€„á€·á€ºá€á€¬á€¡á€á€±á€¸)</option>
                </select>
            </div>
            
            <button class="btn btn-save" onclick="saveSettings()" style="margin-top: 15px;">
                <span>ğŸ’¾ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€™á€Šá€º</span>
            </button>

            <h3 style="color: var(--danger);">Invoice Number á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯</h3>
            <p>á€œá€€á€ºá€›á€¾á€­ Invoice Number: <strong id="currentInvNumber">000001</strong></p>
            <div class="form-group">
                <button class="btn btn-danger" onclick="resetInvoiceNumber()">
                    <span>ğŸ”„ Invoice Number 000001 á€™á€¾ á€•á€¼á€”á€ºá€…á€™á€Šá€º (Reset)</span>
                </button>
            </div>

            <h3 style="color: var(--danger);">ğŸ“Š Data Storage Status</h3>
            <p>á€œá€€á€ºá€›á€¾á€­ Data á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ á€•á€™á€¬á€ (IndexedDB): <strong id="dbStorageSize">á€á€½á€€á€ºá€á€»á€€á€ºá€”á€±á€•á€«á€á€Šá€º...</strong></p>
        </div>
    </div>

  </div>
</div>

<!-- Central Calculator Modal -->
<div id="calculatorModal" class="calculator-modal">
    <div class="calculator-container">
        <div class="calculator-header">
            <div class="calculator-title">á€‚á€á€”á€ºá€¸á€á€½á€€á€ºá€…á€€á€º</div>
            <button class="calculator-close" onclick="closeCalculator()">âœ–ï¸</button>
        </div>
        <div class="calculator-display">
            <div class="calculator-total-display" id="calculatorTotalDisplay">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: 0</div>
            <div class="calculator-value-display" id="calculatorDisplay">0</div>
        </div>
        <div class="calculator-buttons-grid">
            <button class="calculator-btn" onclick="handleCalculatorInput('7')">7</button>
            <button class="calculator-btn" onclick="handleCalculatorInput('8')">8</button>
            <button class="calculator-btn" onclick="handleCalculatorInput('9')">9</button>
            <button class="calculator-btn action clear" onclick="handleCalculatorInput('clear')">C</button>
            
            <button class="calculator-btn" onclick="handleCalculatorInput('4')">4</button>
            <button class="calculator-btn" onclick="handleCalculatorInput('5')">5</button>
            <button class="calculator-btn" onclick="handleCalculatorInput('6')">6</button>
            <button class="calculator-btn action" onclick="handleCalculatorInput('back')"><i class="fas fa-backspace"></i></button>

            <button class="calculator-btn" onclick="handleCalculatorInput('1')">1</button>
            <button class="calculator-btn" onclick="handleCalculatorInput('2')">2</button>
            <button class="calculator-btn" onclick="handleCalculatorInput('3')">3</button>
            <button class="calculator-btn action apply" onclick="handleCalculatorInput('apply')">OK</button>
            
            <button class="calculator-btn" onclick="handleCalculatorInput('0')">0</button>
            <button class="calculator-btn" onclick="handleCalculatorInput('00')">00</button>
            <button class="calculator-btn" onclick="handleCalculatorInput('.')">.</button>
            <button class="calculator-btn action" onclick="handleCalculatorInput('total')">Total</button>
        </div>
    </div>
</div>

<!-- Product Modal and other HTML elements remain the same -->
<div id="productModal" class="modal">
  <div class="modal-content">
    <div class="modal-title" id="productModalTitle">á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸</div>
    
    <div class="form-group">
        <label for="productName" class="form-label">á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€º:</label>
        <input type="text" id="productName" class="form-input" placeholder="á€™á€¯á€”á€·á€ºáŠ á€á€±á€¬á€€á€ºá€…á€›á€¬ á€¡á€™á€Šá€º">
    </div>
      
    <div class="form-group">
        <label for="productPrice" class="form-label">á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸ (MMK):</label>
        <input type="number" id="productPrice" class="form-input" placeholder="á€¥á€•á€™á€¬: 1500" min="0">
    </div>
      
    <div class="form-group">
        <label for="productCategory" class="form-label">á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸:</label>
        <select id="productCategory" class="form-select">
            </select>
    </div>
      
    <div class="form-group">
        <label class="form-label">á€“á€¬á€á€ºá€•á€¯á€¶á€‘á€Šá€·á€ºá€›á€”á€º:</label>
        <div class="image-upload-area" onclick="document.getElementById('productImageFile').click()">
            <input type="file" id="productImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <p style="margin: 0;">á€•á€¯á€¶á€‘á€Šá€·á€ºá€›á€”á€º á€¤á€”á€±á€›á€¬á€€á€­á€¯ á€”á€¾á€­á€•á€ºá€•á€« (á€á€­á€¯á€·) á€•á€¯á€¶á€€á€­á€¯ á€†á€½á€²á€‘á€Šá€·á€ºá€•á€«</p>
        </div>
        <div id="imagePreviewContainer" class="image-preview-container" style="display:none;">
            <img id="imagePreview" class="image-preview" alt="Preview" onerror="this.src='DEFAULT_IMAGE'">
            <button class="delete-image-btn" onclick="deleteImage(event)">âœ–ï¸</button>
            </div>
    </div>
    
    <div id="productError" class="error-message" style="display:none; color: var(--danger); font-weight: bold;"></div>

    <div class="modal-actions">
        <button class="btn btn-save" onclick="saveProduct()" style="flex: 2;">
          <span>ğŸ’¾ á€á€­á€™á€ºá€¸á€™á€Šá€º</span>
        </button>
        <button class="btn btn-clear" onclick="closeProductModal(true)" style="flex: 1;">
          <span>âœ–ï¸ á€•á€šá€ºá€–á€»á€€á€ºá€™á€Šá€º</span>
        </button>
    </div>
  </div>
</div>

<div id="printArea" style="display:none;"></div>

<div id="toast-message">
    <i class="fas fa-check-circle" style="font-size: 20px;"></i>
    <span id="toast-text">á€•á€…á€¹á€…á€Šá€ºá€¸á€€á€­á€¯ á€á€½á€”á€ºá€¸á€œá€¾á€Šá€ºá€¸á€‘á€² á€‘á€Šá€·á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹</span>
</div>
<script>
// ==================== GLOBAL DB & Variable Setup ====================

// IndexedDB Setup using Dexie
const db = new Dexie('pos_db');
db.version(1).stores({
    products: '++id, name, category, stock', // ++id is auto-increment primary key
    salesHistory: '++id, invoiceId, dateTime', // invoiceId as secondary index
    settings: 'key', // key as primary key ('appSettings')
    systemVars: 'key' // key as primary key ('invoiceNumber')
});

let products = [];
let salesHistory = []; 
let cart = [];
let currentEditingProductId = null;
const LOW_STOCK_THRESHOLD = 5; 

let settings = {};
let invoiceNumber = 1; 

const categories = [
  { id: 1, name: 'á€¡á€¬á€¸á€œá€¯á€¶á€¸' },
  { id: 2, name: 'á€¡á€“á€­á€€á€¡á€…á€¬á€¸á€¡á€…á€¬' },
  { id: 3, name: 'á€¡á€¡á€±á€¸/á€á€±á€¬á€€á€ºá€…á€›á€¬' },
  { id: 4, name: 'á€¡á€á€»á€­á€¯á€•á€½á€²/Snacks' },
  { id: 5, name: 'á€¡á€á€¼á€¬á€¸' },
  { id: 6, name: 'á€œá€»á€¾á€±á€¬á€·á€ˆá€±á€¸ Card' } 
];

// Default Image Placeholders
const DEFAULT_IMAGE = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="90" height="90" viewBox="0 0 90 90"><rect width="90" height="90" fill="%23EFEFEF"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="14" fill="%23999999">No Image</text></svg>'; 
const NO_IMAGE_PLACEHOLDER = ''; 
let currentModalImageBase64 = NO_IMAGE_PLACEHOLDER; // Needed for modal scope

// Calculator Variables
let currentCalculatorValue = '0';
let isNewCalculatorNumber = true; 
let calculatorTargetInputId = '';


// ==================== Helper/Utility Functions ====================
function formatCurrency(amount, withUnit = true) {
    const formatted = Math.round(amount).toLocaleString();
    return withUnit ? `${formatted} á€€á€»á€•á€º` : formatted; 
}

function formatInvoiceNumber(num) {
    return String(num).padStart(6, '0');
}

function getCategoryName(id) {
    const cat = categories.find(c => c.id === id);
    return cat ? cat.name : 'N/A';
}

function getFormattedDateTime(date) {
    const d = new Date(date);
    const dateStr = d.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' });
    const timeStr = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    return `${dateStr.replace(/\//g, '-')} ${timeStr}`;
}

function getDateOnly(dateString) {
    if (!dateString) return null;
    const [year, month, day] = dateString.split('-').map(Number);
    // Use UTC to prevent timezone issues when comparing dates
    return new Date(Date.UTC(year, month - 1, day)); 
}

function getTodayDateString() {
    const today = new Date();
    // Use UTC to get the date part consistently
    const year = today.getUTCFullYear();
    const month = String(today.getUTCMonth() + 1).padStart(2, '0');
    const day = String(today.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}


// Toast Message UI/UX
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast-message');
    const icon = toast.querySelector('i');
    const text = document.getElementById('toast-text');
    
    // Set message and theme
    text.textContent = message;
    toast.style.backgroundColor = type === 'success' ? 'var(--success)' : (type === 'danger' ? 'var(--danger)' : 'var(--info)');
    icon.className = type === 'success' ? 'fas fa-check-circle' : (type === 'danger' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle');

    // Show toast
    toast.classList.add('show');
    
    // Hide toast after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}


// ==================== Calculator Functions ====================

function openCalculator(targetInputId = null) {
    const calculator = document.getElementById('calculatorModal');
    calculatorTargetInputId = targetInputId;
    
    // Initialize calculator value with current input value or '0'
    let initialValue = '0';
    if (targetInputId) {
        const targetInput = document.getElementById(targetInputId);
        initialValue = targetInput.value || '0';
    }
    
    currentCalculatorValue = initialValue;
    isNewCalculatorNumber = true;
    
    // Update calculator display
    document.getElementById('calculatorDisplay').textContent = currentCalculatorValue;
    
    // Update total display
    const totalElement = document.getElementById('total');
    const totalValue = totalElement.textContent;
    document.getElementById('calculatorTotalDisplay').textContent = `á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: ${totalValue}`;
    
    calculator.classList.add('active');
    
    // Auto-focus on mobile devices
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        // On mobile, we'll let the user interact with the calculator directly
    }
}

function closeCalculator() {
    const calculator = document.getElementById('calculatorModal');
    calculator.classList.remove('active');
    calculatorTargetInputId = '';
}

function handleCalculatorInput(action) {
    const display = document.getElementById('calculatorDisplay');
    const totalDisplay = document.getElementById('calculatorTotalDisplay');
    
    if (action === 'clear') {
        currentCalculatorValue = '0';
        isNewCalculatorNumber = true;
    } else if (action === 'back') {
        if (currentCalculatorValue.length > 1) {
            currentCalculatorValue = currentCalculatorValue.slice(0, -1);
        } else {
            currentCalculatorValue = '0';
            isNewCalculatorNumber = true;
        }
    } else if (action === 'apply') {
        // Apply the value to the target input
        if (calculatorTargetInputId) {
            const finalValue = parseFloat(currentCalculatorValue) || 0;
            document.getElementById(calculatorTargetInputId).value = finalValue;
            document.getElementById(calculatorTargetInputId).dispatchEvent(new Event('change')); // Trigger calculation
        }
        closeCalculator();
        return;
    } else if (action === 'total') {
        // Set calculator value to the total amount
        const totalElement = document.getElementById('total');
        const totalValue = parseInt(totalElement.textContent.replace(/[^\d.]/g, '')) || 0;
        currentCalculatorValue = totalValue.toString();
        isNewCalculatorNumber = true;
    } else if (!isNaN(action) || action === '.') { // Numbers and dot
        if (isNewCalculatorNumber) {
            currentCalculatorValue = (action === '.') ? '0.' : action;
            isNewCalculatorNumber = false;
        } else {
            if (action === '.') {
                if (!currentCalculatorValue.includes('.')) {
                    currentCalculatorValue += '.';
                }
            } else {
                currentCalculatorValue += action;
            }
        }
        
        // Prevent leading zero unless it's a decimal
        if (currentCalculatorValue.length > 1 && currentCalculatorValue.startsWith('0') && !currentCalculatorValue.startsWith('0.')) {
            currentCalculatorValue = currentCalculatorValue.substring(1);
        }
    }

    display.textContent = currentCalculatorValue;
    
    // Update total display
    const totalElement = document.getElementById('total');
    const totalValue = totalElement.textContent;
    totalDisplay.textContent = `á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: ${totalValue}`;
}


// ==================== Image Upload Handling ====================
function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) { 
             showToast("á€•á€¯á€¶á€¡á€›á€½á€šá€ºá€¡á€…á€¬á€¸ (Size) 5 MB á€‘á€€á€ºá€™á€€á€¼á€®á€¸á€›á€•á€«á‹", 'danger');
             event.target.value = ''; 
             return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            currentModalImageBase64 = e.target.result;
            showImagePreview(currentModalImageBase64);
        };
        reader.readAsDataURL(file);
    }
}

function showImagePreview(base64Image) {
    const previewContainer = document.getElementById('imagePreviewContainer');
    const previewImage = document.getElementById('imagePreview');
    const uploadArea = document.querySelector('.image-upload-area');
    
    const hasImage = base64Image && base64Image !== NO_IMAGE_PLACEHOLDER;

    if (hasImage) {
        previewImage.src = base64Image;
        previewContainer.style.display = 'flex';
        uploadArea.style.display = 'none';
    } else {
        previewImage.src = DEFAULT_IMAGE; // Use SVG placeholder if no image
        previewImage.onerror = function() { this.src = DEFAULT_IMAGE; };
        previewContainer.style.display = 'none';
        uploadArea.style.display = 'block';
    }
}

function deleteImage(event) {
    event.stopPropagation(); 
    currentModalImageBase64 = NO_IMAGE_PLACEHOLDER;
    document.getElementById('productImageFile').value = ''; 
    showImagePreview(NO_IMAGE_PLACEHOLDER);
}


// ==================== IndexedDB Data Loading/Saving ====================

/**
 * IndexedDB á€™á€¾ Data á€™á€»á€¬á€¸á€€á€­á€¯ á€šá€°á€†á€±á€¬á€„á€ºá€á€¼á€„á€ºá€¸
 */
async function loadData() {
    try {
        // 1. Products
        let loadedProducts = await db.products.toArray();
        if (loadedProducts.length === 0) {
            // No data in DB, load dummy data
            loadedProducts = [
                // âš ï¸ Set a very large stock (999999) since stock is not managed now
                { id: 1, name: 'Chicken Burger', price: 3500, category: 2, stock: 999999, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="90" height="90" viewBox="0 0 90 90"><rect width="90" height="90" fill="%23FFE0B2"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="14" fill="%23000">CB</text></svg>' },
                { id: 2, name: 'Original Burger', price: 3000, category: 2, stock: 999999, image: NO_IMAGE_PLACEHOLDER }, 
                { id: 3, name: 'Cola', price: 1000, category: 3, stock: 999999, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="90" height="90" viewBox="0 0 90 90"><rect width="90" height="90" fill="%238D6E63"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="14" fill="%23FFF">CL</text></svg>' },
                { id: 4, name: 'Fried Chicken', price: 1500, category: 2, stock: 999999, image: NO_IMAGE_PLACEHOLDER }, 
                { id: 5, name: 'VIP Discount Card', price: 5000, category: 6, stock: 999999, image: 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="90" height="90" viewBox="0 0 90 90"><rect width="90" height="90" fill="%23FFD700"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="14" fill="%23000">Card</text></svg>' },
            ];
            await db.products.bulkAdd(loadedProducts);
        }
        
        products = loadedProducts.map(p => ({
             ...p,
             categoryName: getCategoryName(p.category),
             image: p.image || NO_IMAGE_PLACEHOLDER
        }));

        // 2. Sales History
        salesHistory = await db.salesHistory.orderBy('id').reverse().toArray();
        
        // ğŸ†• NEW: Calculate Total Sales Qty for each product
        products.forEach(p => {
             p.totalSalesQty = salesHistory.reduce((sum, sale) => {
                 const item = sale.items.find(i => i.id === p.id);
                 return sum + (item ? item.qty : 0);
             }, 0);
        });

        // 3. Settings
        const savedSettings = await db.settings.get('appSettings');
        if (savedSettings) {
            settings = savedSettings.value;
        } else {
            settings = {
                shopName: 'My POS Shop',
                shopAddress: 'No. 123, Downtown',
                shopPhone: '09-123456789',
                receiptThankYou: 'á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€šá€ºáŠ á€”á€±á€¬á€€á€ºá€™á€¾á€•á€¼á€”á€ºá€œá€¬á€á€²á€·á€•á€«á€¦á€¸á‹',
                receiptSize: '80mm',
                theme: 'light' 
            };
            await db.settings.put({ key: 'appSettings', value: settings });
        }
        
        // 4. Invoice Number
        const savedInvoiceNum = await db.systemVars.get('invoiceNumber');
        if (savedInvoiceNum) {
            invoiceNumber = savedInvoiceNum.value;
        } else {
            await db.systemVars.put({ key: 'invoiceNumber', value: 1 });
            invoiceNumber = 1;
        }

    } catch (error) {
        console.error("IndexedDB Load Error:", error);
        alert("IndexedDB á€™á€¾ Data á€™á€»á€¬á€¸á€á€„á€ºá€›á€¬á€á€½á€„á€º á€¡á€á€€á€ºá€¡á€á€²á€›á€¾á€­á€•á€«á€á€Šá€ºá‹");
    }
}

/**
 * á€œá€€á€ºá€›á€¾á€­ IndexedDB á á€•á€™á€¬á€á€€á€­á€¯ á€á€½á€€á€ºá€á€»á€€á€ºá€•á€¼á€®á€¸ Setting Tab á€á€½á€„á€º á€•á€¼á€á€á€¼á€„á€ºá€¸ (Estimated)
 */
async function checkDBStorageSize() {
    const sizeDisplay = document.getElementById('dbStorageSize');
    if ('storage' in navigator && 'estimate' in navigator.storage) {
        try {
            const estimate = await navigator.storage.estimate();
            const usageMB = (estimate.usage / (1024 * 1024)).toFixed(2);
            sizeDisplay.textContent = `${usageMB} MB (Total Est.)`;
        } catch (error) {
            sizeDisplay.textContent = "Error (Cannot Estimate)";
        }
    } else {
        sizeDisplay.textContent = "Browser Not Supported";
    }
}

// ==================== Initialization & Navigation ====================
async function init() {
    await loadData(); // Wait for data to load from DB
    
    document.body.classList.remove('light-theme', 'dark-theme');
    document.body.classList.add(`${settings.theme}-theme`);
    
    setupNavigation();

    populateCategoryFilters('managementCategoryFilter');
    populateCategoryFilters('posCategoryFilter');
    populateCategorySelect();  
    
    // Initial Renders (must be after loadData)
    await renderProductsTable();  
    await renderPOSProducts();    
    renderCart();           
    await renderDashboard();
    await renderReportsTable();
    loadSettings(); 
    checkDBStorageSize(); 

    document.getElementById('managementSearchBox').addEventListener('input', renderProductsTable);
    document.getElementById('reportProductNameSearch').addEventListener('input', renderReportsTable);

    document.getElementById('currentInvNumber').textContent = formatInvoiceNumber(invoiceNumber);
    updateNavCartCount();
}

function setupNavigation() {
    const tabs = document.querySelectorAll('.nav-tab');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', async () => {
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            tab.classList.add('active');
            const targetId = tab.getAttribute('data-tab');
            document.getElementById(targetId).classList.add('active');
            
            closeCalculator();

            // Re-render data when switching tabs to ensure freshest data from DB
            // âš ï¸ Need to loadData to refresh totalSalesQty when sales are made
            if (targetId === 'management-section') { await loadData(); await renderProductsTable(); }
            if (targetId === 'pos-section') await renderPOSProducts();
            if (targetId === 'dashboard-section') await renderDashboard(); 
            if (targetId === 'reports-section') await renderReportsTable(); 
            if (targetId === 'settings-section') {
                 loadSettings();
                 checkDBStorageSize();
            }
        });
    });
}


// Category Populate Functions
function populateCategoryFilters(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        select.appendChild(option);
    });
}

function populateCategorySelect() {
    const select = document.getElementById('productCategory');
    select.innerHTML = '';
    categories.filter(c => c.id !== 1).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        select.appendChild(option);
    });
}

// ==================== Product Management Table (Management Tab) ====================
async function renderProductsTable() {
  products = await db.products.toArray(); 
  
  // Re-calculate totalSalesQty as it's needed here
  products.forEach(p => {
     p.totalSalesQty = salesHistory.reduce((sum, sale) => {
         const item = sale.items.find(i => i.id === p.id);
         return sum + (item ? item.qty : 0);
     }, 0);
     p.categoryName = getCategoryName(p.category);
     p.image = p.image || NO_IMAGE_PLACEHOLDER;
  });
  
  const tableBody = document.getElementById('productsTableBody');
  tableBody.innerHTML = '';
  
  const searchTerm = document.getElementById('managementSearchBox').value.toLowerCase();
  const filterCategoryId = parseInt(document.getElementById('managementCategoryFilter').value);
  
  // Filtering logic simplified as stock-based sorting is removed
  let filteredProducts = products.filter(p => {
    const matchesSearch = p.name.toLowerCase().includes(searchTerm);
    const matchesFilter = filterCategoryId === 1 || p.category === filterCategoryId;
    return matchesSearch && matchesFilter;
  }).sort((a, b) => a.name.localeCompare(b.name, 'my')); // Sort by name
  
  if (filteredProducts.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center; padding:20px; color:var(--text-light);">
          á€•á€…á€¹á€…á€Šá€ºá€¸á€…á€¬á€›á€„á€ºá€¸á€™á€á€½á€±á€·á€•á€«
        </td>
      </tr>
    `;
    return;
  }
  
  filteredProducts.forEach((product, index) => {
    // Removed all stock-related logic and low-stock highlighting
    
    const imageSrc = product.image && product.image !== NO_IMAGE_PLACEHOLDER ? product.image : NO_IMAGE_PLACEHOLDER;
    const imageDisplay = imageSrc ? 
        `<img src="${imageSrc}" alt="${product.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;" onerror="this.classList.add('hidden')">` : 
        `<span style="color:var(--text-light); font-size: 10px;">(á€•á€¯á€¶á€™á€›á€¾á€­)</span>`;


    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td> <td style="text-align: center;">${imageDisplay}</td>
      <td>${product.name}</td>
      <td>${formatCurrency(product.price, true)}</td>
      <td>${product.categoryName}</td>
      <td>**${product.totalSalesQty}**</td> <td class="action-cell">
        <button class="action-icon edit-icon" onclick="openProductModal(${product.id})" title="á€•á€¼á€„á€ºá€™á€Šá€º">
            &#9998;
        </button>
        <button class="action-icon delete-icon" onclick="deleteProduct(${product.id})" title="á€–á€»á€€á€ºá€™á€Šá€º">
            &#128465;
        </button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

// ğŸ†• NEW: Excel Export Function for Product Table
function exportProductTableToExcel() {
    const tableElement = document.querySelector(".product-management-table");
    if (!tableElement || tableElement.rows.length <= 1) {
        showToast("Export á€œá€¯á€•á€ºá€›á€”á€º Data á€™á€›á€¾á€­á€•á€«!", 'danger');
        return;
    }
    
    // Create new table HTML without the action column
    const headerRow = tableElement.tHead.rows[0];
    const headerCells = Array.from(headerRow.cells).slice(0, headerRow.cells.length - 1); 
    
    const bodyRows = Array.from(tableElement.tBodies[0].rows);
    
    // Construct HTML for export (Excel/CSV format)
    const tab_text = `
        <table>
            <thead>
                <tr>
                    ${headerCells.map(cell => `<th>${cell.textContent}</th>`).join('')}
                </tr>
            </thead>
            <tbody>
                ${bodyRows.map(row => 
                    // Exclude the last column (Action) and the second column (Image)
                    `<tr>${Array.from(row.cells).filter((_, i) => i !== 1 && i !== row.cells.length - 1).map(cell => `<td>${cell.textContent.trim()}</td>`).join('')}</tr>`
                ).join('')}
            </tbody>
        </table>
    `;
    
    const fileName = `Product_List_${getTodayDateString()}.xls`;
    
    const blob = new Blob([tab_text], { type: 'application/vnd.ms-excel' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showToast("Excel á€–á€­á€¯á€„á€º á€’á€±á€«á€„á€ºá€¸á€œá€¯á€’á€º á€œá€¯á€•á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹");
}


// ==================== Product Modal (Form Logic) ====================
async function openProductModal(productId = null) {
  closeCalculator();
    
  const modal = document.getElementById('productModal');
  const errorDiv = document.getElementById('productError');
  const modalTitle = document.getElementById('productModalTitle');
  errorDiv.style.display = 'none';
  errorDiv.textContent = '';
  
  document.getElementById('productName').value = '';
  document.getElementById('productPrice').value = '';
  // âš ï¸ Removed: document.getElementById('productStock').value = 1; 
  document.getElementById('productCategory').value = categories[1].id; 
  document.getElementById('productImageFile').value = '';
  currentEditingProductId = null;
  currentModalImageBase64 = NO_IMAGE_PLACEHOLDER; 
  showImagePreview(NO_IMAGE_PLACEHOLDER); 

  if (productId !== null) {
    const product = products.find(p => p.id === productId) || await db.products.get(productId);
    if (product) {
        document.getElementById('productName').value = product.name;
        document.getElementById('productPrice').value = product.price;
        // âš ï¸ Removed: document.getElementById('productStock').value = product.stock; 
        document.getElementById('productCategory').value = product.category;
        
        currentModalImageBase64 = product.image || NO_IMAGE_PLACEHOLDER;
        showImagePreview(currentModalImageBase64);
        
        currentEditingProductId = productId;
        modalTitle.textContent = 'á€•á€…á€¹á€…á€Šá€ºá€¸á€•á€¼á€„á€ºá€†á€„á€ºá€á€¼á€„á€ºá€¸';
    }
  } else {
    modalTitle.textContent = 'á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸';
  }
  
  modal.style.display = 'block';
  setTimeout(() => modal.classList.add('active'), 10); 
}

function closeProductModal(clearForm = false) {
  const modal = document.getElementById('productModal');
  modal.classList.remove('active'); 
  setTimeout(() => {
    modal.style.display = 'none';
    if (clearForm) {
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        // âš ï¸ Removed: document.getElementById('productStock').value = 1; 
        document.getElementById('productCategory').value = categories[1].id;
        document.getElementById('productError').style.display = 'none';
        document.getElementById('productImageFile').value = '';
        currentModalImageBase64 = NO_IMAGE_PLACEHOLDER;
        currentEditingProductId = null;
        showImagePreview(NO_IMAGE_PLACEHOLDER);
    }
  }, 300); 
}

async function deleteProduct(id) {
    if (confirm('á€’á€®á€•á€…á€¹á€…á€Šá€ºá€¸á€€á€­á€¯ á€…á€¬á€›á€„á€ºá€¸á€‘á€²á€€á€”á€± á€–á€»á€€á€ºá€™á€¾á€¬á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?')) {
        try {
            await db.products.delete(id);
            // âš ï¸ Sales history still retains records of this deleted product by ID
            
            await loadData(); // Reload to update product list and totalSalesQty
            await renderProductsTable();
            await renderPOSProducts();
            showToast('á€•á€…á€¹á€…á€Šá€ºá€¸á€–á€»á€€á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®', 'danger');
            checkDBStorageSize();
        } catch (error) {
            console.error("Delete Product Error:", error);
            showToast("á€•á€…á€¹á€…á€Šá€ºá€¸á€–á€»á€€á€ºá€›á€¬á€á€½á€„á€º á€¡á€á€€á€ºá€¡á€á€²á€›á€¾á€­á€•á€«á€á€Šá€ºá‹", 'danger');
        }
    }
}

async function saveProduct() {
    const name = document.getElementById('productName').value.trim();
    const price = parseFloat(document.getElementById('productPrice').value);
    // âš ï¸ Removed: const stock = parseInt(document.getElementById('productStock').value); 
    const categoryId = parseInt(document.getElementById('productCategory').value);
    const errorDiv = document.getElementById('productError');
    errorDiv.style.display = 'none';
    
    if (!name || isNaN(price) || price <= 0) {
        errorDiv.textContent = 'á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€ºá€”á€¾á€„á€·á€º á€™á€¾á€”á€ºá€€á€”á€ºá€á€±á€¬ á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸á€‘á€Šá€·á€ºá€•á€«';
        errorDiv.style.display = 'block';
        return;
    }
    
    // âš ï¸ Removed Stock validation
    
    const finalImage = currentModalImageBase64 || NO_IMAGE_PLACEHOLDER;
    const categoryName = getCategoryName(categoryId);
    
    const productData = {
        name,
        price,
        stock: 999999, // âš ï¸ Set a very high stock as it is not being managed/validated
        category: categoryId,
        categoryName,
        image: finalImage
    };
    
    try {
        if (currentEditingProductId) {
            const oldProduct = products.find(p => p.id === currentEditingProductId);
            const dataToUpdate = {
                ...productData,
                // Preserve the old stock value in DB, even though it's ignored now
                stock: oldProduct ? oldProduct.stock : 999999 
            };
            await db.products.update(currentEditingProductId, dataToUpdate);
            showToast(`á€•á€…á€¹á€…á€Šá€ºá€¸ "${name}" á€€á€­á€¯ á€•á€¼á€„á€ºá€†á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹`);
        } else {
            await db.products.add(productData);
            showToast(`á€•á€…á€¹á€…á€Šá€ºá€¸ "${name}" á€€á€­á€¯ á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹`);
        }
        
        // Re-load to update totalSalesQty and products array
        await loadData(); 
        await renderProductsTable();
        await renderPOSProducts();
        closeProductModal(true);
        checkDBStorageSize();
        
    } catch (error) {
        console.error("Save Product Error:", error);
        errorDiv.textContent = 'á€•á€…á€¹á€…á€Šá€ºá€¸á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹';
        errorDiv.style.display = 'block';
    }
}

// ==================== POS Product List (POS Tab - Enhanced UI) ====================
async function renderPOSProducts() {
    products = await db.products.toArray();
    products = products.map(p => ({
     ...p,
     categoryName: getCategoryName(p.category),
     image: p.image || NO_IMAGE_PLACEHOLDER
    }));
    
    const grid = document.getElementById('posProductGrid');
    grid.innerHTML = '';

    const filterCategoryId = parseInt(document.getElementById('posCategoryFilter').value);
    const searchTerm = document.getElementById('posProductSearch').value.toLowerCase();

    const filteredProducts = products.filter(p => {
        const matchesCategory = filterCategoryId === 1 || p.category === filterCategoryId;
        const matchesSearch = p.name.toLowerCase().includes(searchTerm);
        return matchesCategory && matchesSearch;
    });

    if (filteredProducts.length === 0) {
        grid.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 20px;">á€•á€…á€¹á€…á€Šá€ºá€¸á€™á€›á€¾á€­á€•á€« (á€á€­á€¯á€·) á€›á€¾á€¬á€–á€½á€±á€™á€¾á€¯á€”á€¾á€„á€·á€ºá€™á€€á€­á€¯á€€á€ºá€Šá€®á€•á€«</div>';
        return;
    }

    filteredProducts.forEach(product => {
        const item = document.createElement('div');
        item.className = 'product-item';

        // âš ï¸ Simplified availability check since stock isn't validated
        const isAvailable = true; 
        if (isAvailable) {
             item.onclick = () => addToCart(product);
        } else {
             item.style.opacity = '0.5';
             item.style.cursor = 'not-allowed';
             item.title = 'á€›á€±á€¬á€„á€ºá€¸á€á€»á€›á€”á€ºá€™á€›á€”á€­á€¯á€„á€ºá€•á€«';
        }
       
        const imageSrc = product.image && product.image !== NO_IMAGE_PLACEHOLDER ? product.image : NO_IMAGE_PLACEHOLDER;
        const hasImage = !!imageSrc;

        if (!hasImage) {
            item.classList.add('no-image');
        }

        item.innerHTML = `
            ${hasImage ? `<img src="${imageSrc}" alt="${product.name}" onerror="this.classList.add('hidden'); this.parentNode.classList.add('no-image');">` : ''}
            <div class="product-info">
                <div class="product-name" title="${product.name}">${product.name}</div>
            </div>
            <div class="product-price">${formatCurrency(product.price, false)}</div>
        `;
        grid.appendChild(item);
    });
}


// ==================== POS Cart Management & Calculation (REVISED) ====================

function updateNavCartCount() {
    const count = cart.reduce((sum, item) => sum + item.qty, 0);
    const navCount = document.getElementById('navCartCount');
    navCount.textContent = count;
    navCount.style.display = count > 0 ? 'block' : 'none';
}

/**
 * Cart á€‘á€²á€á€­á€¯á€· á€•á€…á€¹á€…á€Šá€ºá€¸á€‘á€Šá€·á€ºá€á€¼á€„á€ºá€¸
 */
function addToCart(product) {
    const existingItem = cart.find(item => item.id === product.id);
    
    if (existingItem) {
        // âš ï¸ Removed Stock Validation
        existingItem.qty += 1;
    } else {
        // âš ï¸ Removed Stock Validation for first addition
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            qty: 1,
            // âš ï¸ Removed image property since we're not showing images in cart
            // âš ï¸ Removed stock/category properties
        });
    }

    renderCart();
    showToast(`"${product.name}" á€€á€­á€¯ á€á€½á€”á€ºá€¸á€œá€¾á€Šá€ºá€¸á€‘á€² á€‘á€Šá€·á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹`);
}

/**
 * Cart Item á á€¡á€›á€±á€¡á€á€½á€€á€ºá€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸
 */
function updateCartItemQty(productId, change) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    
    if (itemIndex !== -1) {
        const item = cart[itemIndex];
        const newQty = item.qty + change;
        
        // âš ï¸ Removed Stock Validation

        if (newQty > 0) {
            item.qty = newQty;
        } else {
            // Remove item if quantity becomes 0 or less
            cart.splice(itemIndex, 1);
            showToast(`"${item.name}" á€€á€­á€¯ á€á€½á€”á€ºá€¸á€œá€¾á€Šá€ºá€¸á€‘á€²á€™á€¾ á€–á€šá€ºá€‘á€¯á€á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹`, 'danger');
        }
    }
    renderCart();
}

/**
 * Cart Item á€€á€­á€¯á€œá€¯á€¶á€¸á€á€–á€»á€€á€ºá€á€¼á€„á€ºá€¸ (Delete Icon Function)
 */
function deleteCartItem(productId) {
    const itemIndex = cart.findIndex(item => item.id === productId);
    
    if (itemIndex !== -1) {
        const item = cart[itemIndex];
        cart.splice(itemIndex, 1);
        renderCart();
        showToast(`"${item.name}" á€€á€­á€¯ á€á€½á€”á€ºá€¸á€œá€¾á€Šá€ºá€¸á€‘á€²á€™á€¾ á€–á€šá€ºá€‘á€¯á€á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹`, 'danger');
    }
}

/**
 * Drag & Drop Functions for Cart Items
 */
function handleDragStart(e, productId) {
    draggedItem = cart.findIndex(item => item.id === productId);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.target);
    e.target.classList.add('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const afterElement = getDragAfterElement(e.clientY);
    const draggable = document.querySelector('.dragging');
    
    if (afterElement == null) {
        e.target.closest('.cart-items').appendChild(draggable);
    } else {
        e.target.closest('.cart-items').insertBefore(draggable, afterElement);
    }
}

function handleDragEnter(e) {
    e.preventDefault();
    const item = e.target.closest('.cart-item');
    if (item && !item.classList.contains('dragging')) {
        item.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    const item = e.target.closest('.cart-item');
    if (item && item.classList.contains('drag-over')) {
        item.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    e.preventDefault();
    const item = e.target.closest('.cart-item');
    if (item) {
        item.classList.remove('drag-over');
    }
    
    // Reorder the cart array based on the new DOM order
    const cartItemsContainer = document.getElementById('cartItems');
    const newCart = [];
    const cartItemElements = cartItemsContainer.querySelectorAll('.cart-item');
    
    cartItemElements.forEach(element => {
        const productId = parseInt(element.getAttribute('data-id'));
        const cartItem = cart.find(item => item.id === productId);
        if (cartItem) {
            newCart.push(cartItem);
        }
    });
    
    cart = newCart;
    renderCart();
    showToast('á€…á€»á€±á€¸á€á€¼á€„á€ºá€¸á€œá€¾á€Šá€ºá€¸á€€á€­á€¯ á€•á€¼á€”á€ºá€…á€®á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹', 'info');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.cart-item').forEach(item => {
        item.classList.remove('drag-over');
    });
}

function getDragAfterElement(y) {
    const draggableElements = [...document.querySelectorAll('.cart-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/**
 * Cart UI á€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€ºá€›á€±á€¸á€†á€½á€²á€á€¼á€„á€ºá€¸
 */
function renderCart() {
    const cartItemsDiv = document.getElementById('cartItems');
    cartItemsDiv.innerHTML = '';
    
    if (cart.length === 0) {
        cartItemsDiv.innerHTML = '<div class="empty-cart" style="text-align: center; color: var(--text-light); padding: 15px 0;">á€…á€»á€±á€¸á€á€šá€ºá€á€¼á€„á€ºá€¸á€™á€›á€¾á€­á€á€±á€¸á€•á€«</div>';
        updateNavCartCount(); 
        calculateTotals(); 
        return;
    }

    cart.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        itemDiv.setAttribute('data-id', item.id);
        itemDiv.setAttribute('draggable', 'true');
        
        // Add drag event listeners
        itemDiv.addEventListener('dragstart', (e) => handleDragStart(e, item.id));
        itemDiv.addEventListener('dragover', handleDragOver);
        itemDiv.addEventListener('dragenter', handleDragEnter);
        itemDiv.addEventListener('dragleave', handleDragLeave);
        itemDiv.addEventListener('drop', handleDrop);
        itemDiv.addEventListener('dragend', handleDragEnd);

        // âš ï¸ Removed Stock Alert and Stock Warning in item.innerHTML
        // âš ï¸ Removed image from cart item

        itemDiv.innerHTML = `
            <div class="drag-handle" title="Reorder item">â‹®â‹®</div>
            <div class="cart-item-details">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price-qnty">
                    ${formatCurrency(item.price, false)} / item
                </div>
            </div>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateCartItemQty(${item.id}, -1)">-</button>
                <span class="item-qty">${item.qty}</span>
                <button class="qty-btn" onclick="updateCartItemQty(${item.id}, 1)">+</button>
            </div>
            <div class="cart-item-total">${formatCurrency(item.price * item.qty, false)}</div>
            <button class="cart-delete-btn" onclick="deleteCartItem(${item.id})" title="á€–á€»á€€á€ºá€™á€Šá€º">âŒ</button>
        `;
        cartItemsDiv.appendChild(itemDiv);
    });

    calculateTotals();
    updateNavCartCount();
}


/**
 * Total á€á€½á€€á€ºá€á€»á€€á€ºá€á€¼á€„á€ºá€¸
 */
function calculateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.qty * item.price), 0);
    // Ensure discount input is treated as a number
    const discountPercent = parseFloat(document.getElementById('discount_percent').value) || 0; 
    
    const cashInput = document.getElementById('cash');
    const cash = parseFloat(cashInput.value) || 0;

    const discountAmount = Math.round(subtotal * (discountPercent / 100));
    const total = Math.round(subtotal - discountAmount);
    const change = Math.max(0, cash - total);

    // Update UI elements
    document.getElementById('subtotal').textContent = formatCurrency(subtotal, false);
    document.getElementById('discount-display').textContent = formatCurrency(discountAmount, false);
    document.getElementById('total').textContent = formatCurrency(total, false);
    document.getElementById('cash-display').textContent = formatCurrency(cash, false);
    
    const changeSpan = document.getElementById('change');
    changeSpan.textContent = formatCurrency(change, false);
    
    // Highlight change amount in red if total is due
    if (change === 0 && total > 0 && cash !== 0 && total !== cash) {
        changeSpan.style.color = 'var(--danger)';
    } else {
         changeSpan.style.color = 'var(--secondary)';
    }

    // Highlight cash input if insufficient
    if (total > cash && total > 0) {
        cashInput.style.borderColor = 'var(--danger)';
    } else {
        cashInput.style.borderColor = 'var(--border)';
    }
}


/**
 * Quick Cash Buttons
 */
function setCashAmount(amount) {
    let cashValue = 0;
    const totalElement = document.getElementById('total');
    // Remove currency format and parse total
    const total = parseInt(totalElement.textContent.replace(/[^\d.]/g, '')) || 0;
    
    if (amount === 'auto') {
        if (total === 0) {
            cashValue = 0;
        } else {
            // Auto round up to nearest 500 or 1000
            if (total <= 1000) {
                cashValue = 1000;
            } else {
                // Round up to nearest 1000
                cashValue = Math.ceil(total / 1000) * 1000;
            }
        }
    } else {
        cashValue = amount;
    }
    
    document.getElementById('cash').value = cashValue;
    calculateTotals();
    closeCalculator(); // Close calculator after setting cash
}

/**
 * Cart á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
 */
function clearCart() {
    if (confirm('á€…á€»á€±á€¸á€á€¼á€„á€ºá€¸ (Cart) á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€™á€¾á€¬ á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?')) {
        cart = [];
        document.getElementById('discount_percent').value = ''; 
        document.getElementById('cash').value = '';
        renderCart();
        showToast('á€…á€»á€±á€¸á€á€¼á€„á€ºá€¸á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€‘á€¯á€á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹', 'info');
    }
}


// ==================== Number Pad Logic (Legacy - Keeping for compatibility) ====================

function openNumberPad(isOpen, targetId = null) {
    // This function is kept for compatibility but now redirects to the calculator
    if (isOpen) {
        openCalculator(targetId);
    } else {
        closeCalculator();
    }
}

function handleNumberPadInput(action) {
    // Redirect to calculator input handler
    handleCalculatorInput(action);
}

// ==================== POS Save & Print (REVISED for Auto-Save and Print) ====================
async function saveOrder(isPrint = false) {
  closeCalculator(); 
    
  if (cart.length === 0) {
    showToast('á€á€­á€™á€ºá€¸á€›á€”á€º á€…á€»á€±á€¸á€á€¼á€„á€ºá€¸á€á€½á€„á€º á€•á€…á€¹á€…á€Šá€ºá€¸á€™á€›á€¾á€­á€•á€«!', 'danger');
    return null;
  }

  const subtotal = cart.reduce((sum, item) => sum + (item.qty * item.price), 0);
  const discountPercent = parseFloat(document.getElementById('discount_percent').value) || 0; 
  const discountAmount = Math.round(subtotal * (discountPercent / 100));
  const total = Math.round(subtotal - discountAmount);
  const cash = parseFloat(document.getElementById('cash').value) || 0;
  
  if (total > 0 && cash < total) {
      showToast('á€•á€±á€¸á€„á€½á€± (Cash) á€á€Šá€º á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ (Total) á€‘á€€á€º á€™á€”á€Šá€ºá€¸á€›á€•á€«á‹', 'danger');
      return null;
  }
  
  // âš ï¸ Removed: Stock Validation and Preparation for Update (Since stock is not managed)

  try {
      // 1. (Stock update/validation removed)
      
      // 2. Generate new ID and save Sale Record
      const newSale = {
          invoiceId: invoiceNumber,
          dateTime: new Date().toISOString(),
          subtotal: subtotal,
          discount: discountAmount,
          discountPercent: discountPercent, 
          total: total,
          cash: cash,
          change: Math.max(0, cash - total),
          items: JSON.parse(JSON.stringify(cart))
      };
      
      await db.salesHistory.add(newSale);

      // 3. Update Invoice Number in System Vars
      invoiceNumber++;
      await db.systemVars.put({ key: 'invoiceNumber', value: invoiceNumber });
      
      // Reload necessary data and update UI
      salesHistory.unshift(newSale); // Add to local history for immediate use
      
      if (isPrint) {
          // If print is requested, proceed to generate receipt (Auto Print)
          generateAndPrintReceipt(newSale);
      } else {
          showToast(`á€˜á€±á€¬á€„á€ºá€á€»á€¬á€”á€¶á€•á€«á€á€º ${formatInvoiceNumber(newSale.invoiceId)} á€–á€¼á€„á€·á€º á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹`);
      }
      
      // Auto Clear Sales Cart and update displays
      clearCart();
      document.getElementById('discount_percent').value = ''; 
      document.getElementById('cash').value = '';
        
      // Re-load data to update totalSalesQty in product list
      await loadData(); 
      await renderProductsTable(); // Refresh product list to show new totalSalesQty
      await renderPOSProducts();
      await renderDashboard();
      await renderReportsTable();
      document.getElementById('currentInvNumber').textContent = formatInvoiceNumber(invoiceNumber);
      checkDBStorageSize();

      return newSale;

  } catch (error) {
      console.error("Save Order Error:", error);
      showToast("á€¡á€›á€±á€¬á€„á€ºá€¸á€¡á€á€šá€ºá€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹", 'danger');
      return null;
  }
}

async function printReceipt() {
    // This now calls saveOrder with true, which handles auto-save, print, and cart clear.
    const sale = await saveOrder(true);
    if (!sale) return; 
}
function generateReceiptHTML(sale) {
    const shopName = settings.shopName || 'POS Shop';
    const shopAddress = settings.shopAddress || '';
    const shopPhone = settings.shopPhone || '';
    const thankYou = settings.receiptThankYou || 'á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€šá€º';
    const receiptSizeClass = settings.receiptSize === '58mm' ? 'receipt-58mm' : 'receipt-80mm';

    let itemsHtml = sale.items.map(item => `
        <div class="item-row">
            <span class="item-qty-name">${item.qty} x ${item.name}</span>
            <span class="item-price-total">${formatCurrency(item.qty * item.price, false)}</span>
        </div>
        <div class="item-price-unit">${formatCurrency(item.price, false)} / item</div>
    `).join('');

    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Receipt ${formatInvoiceNumber(sale.invoiceId)}</title>
            <style>
                body {
                    font-family: 'Noto Sans Myanmar', sans-serif;
                    margin: 0;
                    padding: 0;
                    background: white;
                }
                .receipt-container {
                    width: ${settings.receiptSize === '58mm' ? '58mm' : '80mm'};
                    padding: 10px;
                    box-sizing: border-box;
                    margin: 0 auto;
                }
                .header, .footer {
                    text-align: center;
                    margin-bottom: 10px;
                }
                .header h3 { margin: 0; font-size: 16px; }
                .header p { margin: 2px 0; font-size: 12px; }
                .separator { 
                    border-bottom: 1px dashed black; 
                    margin: 5px 0; 
                }
                .item-row { 
                    display: flex; 
                    justify-content: space-between; 
                    font-size: 13px; 
                    font-weight: bold; 
                }
                .item-price-unit {
                    font-size: 11px;
                    text-align: right;
                    margin-bottom: 5px;
                }
                .summary-row {
                    display: flex;
                    justify-content: space-between;
                    font-size: 14px;
                    padding: 3px 0;
                }
                .summary-total {
                    font-size: 18px;
                    font-weight: bold;
                    border-top: 1px dashed black;
                    padding-top: 5px;
                    margin-top: 5px;
                }
                .footer p { font-size: 12px; margin: 5px 0; }
                @media print {
                    .receipt-container { margin: 0; width: ${settings.receiptSize === '58mm' ? '58mm' : '80mm'}; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="receipt-container">
                <div class="header">
                    <h3>${shopName}</h3>
                    <p>${shopAddress}</p>
                    <p>á€–á€¯á€”á€ºá€¸: ${shopPhone}</p>
                    <div class="separator"></div>
                    <p style="font-size: 12px;">á€˜á€±á€¬á€„á€ºá€á€»á€¬ ID: ${formatInvoiceNumber(sale.invoiceId)}</p>
                    <p style="font-size: 12px;">á€›á€€á€ºá€…á€½á€²: ${getFormattedDateTime(sale.dateTime)}</p>
                </div>

                <div class="separator"></div>
                <div class="items-list">${itemsHtml}</div>
                <div class="separator"></div>

                <div class="summary-row"><span>Subtotal:</span><span>${formatCurrency(sale.subtotal, false)}</span></div>
                <div class="summary-row"><span>Discount (${sale.discountPercent}%):</span><span>-${formatCurrency(sale.discount, false)}</span></div>
                
                <div class="summary-row summary-total"><span>TOTAL:</span><span>${formatCurrency(sale.total, false)}</span></div>
                <div class="separator"></div>
                <div class="summary-row"><span>á€•á€±á€¸á€„á€½á€± (Cash):</span><span>${formatCurrency(sale.cash, false)}</span></div>
                <div class="summary-row"><span>á€„á€½á€±á€•á€­á€¯ (Change):</span><span>${formatCurrency(sale.change, false)}</span></div>
                
                <div class="separator"></div>
                <div class="footer">
                    <p>${thankYou}</p>
                    <p style="font-size: 10px;">Powered by Gemini POS</p>
                </div>
            </div>
        </body>
        </html>
    `;
}

function generateAndPrintReceipt(sale) {
    const printWindow = window.open('', 'PRINT', settings.receiptSize === '58mm' ? 'width=300,height=600' : 'width=400,height=600');
    printWindow.document.write(generateReceiptHTML(sale));
    printWindow.document.close(); // necessary for IE
    printWindow.focus(); // necessary for IE
    
    // Use a small delay for print command to ensure all content is rendered
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}


// ==================== Dashboard Functions ====================
function calculateTodaySales() {
    const todayDateStr = getTodayDateString(); 
    let todayTotalSales = 0;

    salesHistory.forEach(sale => {
        const saleDatePart = sale.dateTime.split('T')[0];
        
        if (saleDatePart === todayDateStr) {
            todayTotalSales += sale.total;
        }
    });

    return todayTotalSales;
}

function filterSalesByDateRange(startDateStr, endDateStr) {
    if (!startDateStr || !endDateStr) {
        return salesHistory; 
    }
    
    const startDateObj = getDateOnly(startDateStr);
    const endDateObj = getDateOnly(endDateStr);

    if (!startDateObj || !endDateObj) return [];

    const inclusiveEndDateObj = new Date(endDateObj.getTime());
    inclusiveEndDateObj.setUTCDate(inclusiveEndDateObj.getUTCDate() + 1);

    return salesHistory.filter(sale => {
        const saleDate = new Date(sale.dateTime);
        const saleDateOnly = new Date(Date.UTC(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate()));

        return (saleDateOnly >= startDateObj && saleDateOnly < inclusiveEndDateObj);
    });
}

async function renderDashboard() {
    salesHistory = await db.salesHistory.orderBy('id').reverse().toArray();
    
    // Set default dates if empty
    const todayDate = getTodayDateString();
    let startDateStr = document.getElementById('dashboardRangeStartDate').value;
    let endDateStr = document.getElementById('dashboardRangeEndDate').value;
    
    if (!startDateStr || !endDateStr) {
        startDateStr = todayDate;
        endDateStr = todayDate;
        document.getElementById('dashboardRangeStartDate').value = todayDate;
        document.getElementById('dashboardRangeEndDate').value = todayDate;
    }

    const filteredSales = filterSalesByDateRange(startDateStr, endDateStr);
    
    const totalSales = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
    const totalReceipts = filteredSales.length;
    const totalQuantity = filteredSales.reduce((sum, sale) => sum + sale.items.reduce((itemSum, item) => itemSum + item.qty, 0), 0);
    const totalDiscount = filteredSales.reduce((sum, sale) => sum + sale.discount, 0); 

    const todaySales = calculateTodaySales();

    document.getElementById('todayTotalSales').textContent = formatCurrency(todaySales, false); 
    document.getElementById('dailyTotalSales').textContent = formatCurrency(totalSales, false);
    document.getElementById('dailyTotalDiscount').textContent = formatCurrency(totalDiscount, false); 
    document.getElementById('dailyTotalReceipts').textContent = totalReceipts + ' á€á€¯';
    document.getElementById('dailyTotalQuantity').textContent = totalQuantity + ' á€á€¯';
    
    renderDashboardProductSummary(filteredSales); 
}

function renderDashboardProductSummary(filteredSales = null) {
    if (!filteredSales) {
        const startDateStr = document.getElementById('dashboardRangeStartDate').value;
        const endDateStr = document.getElementById('dashboardRangeEndDate').value;
        filteredSales = filterSalesByDateRange(startDateStr, endDateStr);
    }
    
    const tableBody = document.getElementById('dashboardProductSummaryTable');
    tableBody.innerHTML = '';
    const searchTerm = document.getElementById('dashboardProductNameSearch').value.toLowerCase();

    // Aggregation logic
    const productSummary = {}; // { productId: { name, price, totalQty, totalRevenue, firstSaleDate } }

    filteredSales.forEach(sale => {
        sale.items.forEach(item => {
            if (item.name.toLowerCase().includes(searchTerm)) {
                if (!productSummary[item.id]) {
                    productSummary[item.id] = {
                        name: item.name,
                        price: item.price,
                        totalQty: 0,
                        totalRevenue: 0,
                        firstSaleDate: sale.dateTime
                    };
                }
                productSummary[item.id].totalQty += item.qty;
                productSummary[item.id].totalRevenue += (item.qty * item.price);
                
                // Track the earliest sale date in the range
                if (new Date(sale.dateTime) < new Date(productSummary[item.id].firstSaleDate)) {
                    productSummary[item.id].firstSaleDate = sale.dateTime;
                }
            }
        });
    });

    const summaryArray = Object.values(productSummary).sort((a, b) => b.totalRevenue - a.totalRevenue);

    if (summaryArray.length === 0) {
         tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center; padding:20px; color:var(--text-light);">
              á€•á€…á€¹á€…á€Šá€ºá€¸á€›á€±á€¬á€„á€ºá€¸á€¡á€¬á€¸ á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­á€•á€«
            </td>
          </tr>
        `;
        return;
    }
    
    summaryArray.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${getDateOnly(item.firstSaleDate.split('T')[0]).toLocaleDateString('my-MM')}</td>
            <td>${item.name}</td>
            <td>${formatCurrency(item.price, false)}</td>
            <td>${item.totalQty}</td>
            <td>${formatCurrency(item.totalRevenue, false)}</td>
        `;
        tableBody.appendChild(tr);
    });
}

// Export to Excel (Simplified)
function exportDashboardSummaryToExcel() {
    const table = document.querySelector("#dashboardProductSummaryTable").parentNode.innerHTML;
    if (!table.includes('<tr>')) {
        showToast("Export á€œá€¯á€•á€ºá€›á€”á€º Data á€™á€›á€¾á€­á€•á€«!", 'danger');
        return;
    }
    
    // Use HTML table to Excel trick
    const tab_text = `
        <table>
            <thead>
                <tr>
                    <th>á€›á€€á€ºá€…á€½á€² (á€•á€‘á€™á€›á€±á€¬á€„á€ºá€¸á€›á€€á€º)</th>
                    <th>á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€º</th>
                    <th>á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸/á€á€á€¯</th>
                    <th>Qty á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸</th>
                    <th>Total á€á€„á€ºá€„á€½á€±</th>
                </tr>
            </thead>
            ${table}
        </table>
    `;
    const fileName = `Dashboard_Summary_${document.getElementById('dashboardRangeStartDate').value}_to_${document.getElementById('dashboardRangeEndDate').value}.xls`;
    
    const blob = new Blob([tab_text], { type: 'application/vnd.ms-excel' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showToast("Excel á€–á€­á€¯á€„á€º á€’á€±á€«á€„á€ºá€¸á€œá€¯á€’á€º á€œá€¯á€•á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹");
}


// ==================== Reports Functions (FIXED) ====================
async function renderReportsTable() {
    salesHistory = await db.salesHistory.orderBy('id').reverse().toArray();
    
    const tableBody = document.getElementById('reportsTableBody');
    tableBody.innerHTML = '';

    const startDateStr = document.getElementById('reportStartDate').value;
    const endDateStr = document.getElementById('reportEndDate').value;
    const productNameSearch = document.getElementById('reportProductNameSearch').value.toLowerCase();
    
    let filteredItems = [];
    let totalQty = 0;
    let totalSales = 0;
    
    const filteredSales = filterSalesByDateRange(startDateStr, endDateStr);

    filteredSales.forEach(sale => {
        sale.items.forEach((item) => {
            const invoiceStr = formatInvoiceNumber(sale.invoiceId);
            if (item.name.toLowerCase().includes(productNameSearch) || invoiceStr.includes(productNameSearch)) {
                
                filteredItems.push({
                    invoiceId: sale.invoiceId,
                    dateTime: sale.dateTime,
                    name: item.name,
                    price: item.price,
                    qty: item.qty,
                    itemTotal: item.qty * item.price,
                    discount: sale.discount, 
                    discountPercent: sale.discountPercent, 
                    totalSale: sale.total 
                });

                totalQty += item.qty;
                // Sum item total for report summary, not the total sale amount from invoice
                totalSales += (item.qty * item.price); 
            }
        });
    });

    if (filteredItems.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align:center; padding:20px; color:var(--text-light);">
              á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­á€•á€« (á€á€­á€¯á€·) á€›á€¾á€¬á€–á€½á€±á€™á€¾á€¯á€”á€¾á€„á€·á€ºá€™á€€á€­á€¯á€€á€ºá€Šá€®á€•á€«
            </td>
          </tr>
        `;
    } else {
        filteredItems.sort((a, b) => {
            // Sort by Invoice ID (newest first)
            return b.invoiceId - a.invoiceId; 
        });
        
        filteredItems.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${getFormattedDateTime(item.dateTime)}</td>
              <td>${formatInvoiceNumber(item.invoiceId)}</td>
              <td>${item.name}</td>
              <td>${formatCurrency(item.price, false)}</td>
              <td>${item.qty}</td>
              <td>${formatCurrency(item.itemTotal, false)}</td>
              <td>
                <button class="action-icon receipt-icon" title="á€˜á€±á€¬á€„á€ºá€á€»á€¬á€•á€¼á€”á€ºá€‘á€¯á€á€ºá€™á€Šá€º" onclick="viewReceipt(${item.invoiceId})" style="color: var(--info);">
                    ğŸ§¾
                </button>
                <button class="action-icon delete-icon" title="á€˜á€±á€¬á€„á€ºá€á€»á€¬á€–á€»á€€á€ºá€™á€Šá€º" onclick="deleteSaleByInvoice(${item.invoiceId})" style="color: var(--danger);">
                    &#128465;
                </button>
              </td>
            `;
            tableBody.appendChild(tr);
        });
    }

    document.getElementById('reportTotalQty').textContent = totalQty;
    document.getElementById('reportTotalSales').textContent = formatCurrency(totalSales, false);
}

async function viewReceipt(invoiceId) {
    const sale = salesHistory.find(s => s.invoiceId === invoiceId);
    if (sale) {
        generateAndPrintReceipt(sale);
    } else {
        showToast('á€˜á€±á€¬á€„á€ºá€á€»á€¬á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€á€½á€±á€·á€•á€«', 'danger');
    }
}

async function deleteSaleByInvoice(invoiceId) {
    if (confirm(`á€˜á€±á€¬á€„á€ºá€á€»á€¬á€”á€¶á€•á€«á€á€º ${formatInvoiceNumber(invoiceId)} á€€á€­á€¯ á€–á€»á€€á€ºá€™á€¾á€¬á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?`)) {
        try {
            // âš ï¸ Removed Stock Restoration Logic
            
            await db.salesHistory.where('invoiceId').equals(invoiceId).delete();
            
            await loadData(); // Reload all data to refresh local arrays and totalSalesQty
            await renderReportsTable();
            await renderDashboard();
            await renderProductsTable(); // Refresh management table
            checkDBStorageSize();
            showToast('á€˜á€±á€¬á€„á€ºá€á€»á€¬á€–á€»á€€á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹');
        } catch (error) {
            console.error("Delete Sale Error:", error);
            showToast("á€˜á€±á€¬á€„á€ºá€á€»á€¬á€–á€»á€€á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹", 'danger');
        }
    }
}

async function deleteSalesByDate() {
    const startDateStr = document.getElementById('reportStartDate').value;
    const endDateStr = document.getElementById('reportEndDate').value;
    
    if (!startDateStr || !endDateStr) {
        showToast("á€–á€»á€€á€ºá€œá€­á€¯á€á€±á€¬ á€›á€€á€ºá€…á€½á€² á€¡á€…á€”á€¾á€„á€·á€º á€¡á€†á€¯á€¶á€¸á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€±á€¸á€•á€«á‹", 'danger');
        return;
    }
    
    if (confirm(`á€›á€€á€ºá€…á€½á€² ${startDateStr} á€™á€¾ ${endDateStr} á€¡á€á€½á€„á€ºá€¸á€›á€¾á€­ á€¡á€›á€±á€¬á€„á€ºá€¸á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸ á€¡á€¬á€¸á€œá€¯á€¶á€¸á€€á€­á€¯ á€–á€»á€€á€ºá€™á€¾á€¬ á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸? á€¤á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€á€»á€€á€ºá€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€ºá€•á€¼á€„á€ºá€†á€„á€ºáá€™á€›á€•á€«á‹`)) {
        
        try {
            const startDateObj = getDateOnly(startDateStr);
            const endDateObj = getDateOnly(endDateStr);
            const inclusiveEndDateObj = new Date(endDateObj.getTime());
            inclusiveEndDateObj.setUTCDate(inclusiveEndDateObj.getUTCDate() + 1);

            const salesToDelete = await db.salesHistory.filter(sale => {
                const saleDate = new Date(sale.dateTime);
                const saleDateOnly = new Date(Date.UTC(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate()));
                return (saleDateOnly >= startDateObj && saleDateOnly < inclusiveEndDateObj);
            }).toArray();
            
            if (salesToDelete.length === 0) {
                 showToast("á€–á€»á€€á€ºá€›á€”á€ºá€¡á€á€½á€€á€º á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸á€™á€›á€¾á€­á€•á€«á‹", 'info');
                 return;
            }

            // âš ï¸ Removed Stock Restoration Logic
            
            // 2. Delete Sale Records
            const idsToDelete = salesToDelete.map(s => s.id);
            await db.salesHistory.bulkDelete(idsToDelete);

            await loadData();
            await renderReportsTable();
            await renderDashboard();
            await renderProductsTable(); 
            checkDBStorageSize();
            showToast(`${salesToDelete.length} á€á€¯á€á€±á€¬ á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€–á€»á€€á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹`);
        
        } catch (error) {
            console.error("Delete Sales By Date Error:", error);
            showToast("á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸ á€–á€»á€€á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹", 'danger');
        }
    }
}

// Export Reports to Excel
function exportReportsToExcel() {
    const table = document.querySelector(".reports-table").parentNode.innerHTML;
    if (!table.includes('<tr>')) {
        showToast("Export á€œá€¯á€•á€ºá€›á€”á€º Data á€™á€›á€¾á€­á€•á€«!", 'danger');
        return;
    }
    
    // Use HTML table to Excel trick, excluding the action column
    const tab_text = `
        <table>
            <thead>
                <tr>
                    <th>á€›á€€á€ºá€…á€½á€²/á€¡á€á€»á€­á€”á€º</th>
                    <th>á€˜á€±á€¬á€„á€ºá€á€»á€¬ ID</th>
                    <th>á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€™á€Šá€º</th>
                    <th>á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸/á€á€á€¯</th>
                    <th>Qty</th>
                    <th>Total (Item)</th>
                </tr>
            </thead>
            <tbody>
                ${Array.from(document.getElementById('reportsTableBody').rows).map(row => 
                    `<tr>${Array.from(row.cells).slice(0, 6).map(cell => `<td>${cell.textContent}</td>`).join('')}</tr>`
                ).join('')}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4"></td>
                    <td>Qty á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: ${document.getElementById('reportTotalQty').textContent}</td>
                    <td>Total á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: ${document.getElementById('reportTotalSales').textContent}</td>
                </tr>
            </tfoot>
        </table>
    `;
    
    const fileName = `Sales_Report_${document.getElementById('reportStartDate').value}_to_${document.getElementById('reportEndDate').value}.xls`;
    
    const blob = new Blob([tab_text], { type: 'application/vnd.ms-excel' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    showToast("Excel á€–á€­á€¯á€„á€º á€’á€±á€«á€„á€ºá€¸á€œá€¯á€’á€º á€œá€¯á€•á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹");
}


// ==================== Settings Functions ====================
function loadSettings() {
    document.getElementById('shopName').value = settings.shopName || '';
    document.getElementById('shopAddress').value = settings.shopAddress || '';
    document.getElementById('shopPhone').value = settings.shopPhone || '';
    document.getElementById('receiptThankYou').value = settings.receiptThankYou || '';
    document.getElementById('receiptSize').value = settings.receiptSize || '80mm';
    document.getElementById('themeSelect').value = settings.theme || 'light';
    
    document.getElementById('currentInvNumber').textContent = formatInvoiceNumber(invoiceNumber);
    
    switchTheme(settings.theme, false); // Apply theme on load
}

async function saveSettings() {
    settings.shopName = document.getElementById('shopName').value.trim();
    settings.shopAddress = document.getElementById('shopAddress').value.trim();
    settings.shopPhone = document.getElementById('shopPhone').value.trim();
    settings.receiptThankYou = document.getElementById('receiptThankYou').value.trim();
    settings.receiptSize = document.getElementById('receiptSize').value;
    settings.theme = document.getElementById('themeSelect').value;

    try {
        await db.settings.put({ key: 'appSettings', value: settings });
        switchTheme(settings.theme, false); // Re-apply in case it was changed
        showToast('Settings á€™á€»á€¬á€¸ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹');
    } catch (error) {
        console.error("Save Settings Error:", error);
        showToast('Settings á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹', 'danger');
    }
}

function switchTheme(theme, save = true) {
    document.body.classList.remove('light-theme', 'dark-theme');
    document.body.classList.add(`${theme}-theme`);
    
    if (save) {
        settings.theme = theme;
        saveSettings();
    }
}

async function resetInvoiceNumber() {
    if (confirm('Invoice Number á€€á€­á€¯ 000001 á€™á€¾ á€•á€¼á€”á€ºá€…á€™á€Šá€º (Reset) á€™á€¾á€¬ á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸?')) {
        try {
            await db.systemVars.put({ key: 'invoiceNumber', value: 1 });
            invoiceNumber = 1;
            document.getElementById('currentInvNumber').textContent = formatInvoiceNumber(invoiceNumber);
            showToast('Invoice Number á€€á€­á€¯ Reset á€œá€¯á€•á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹');
        } catch (error) {
             console.error("Reset Invoice Error:", error);
             showToast('Invoice Number Reset á€œá€¯á€•á€ºá€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹', 'danger');
        }
    }
}


// Initialize the system
window.addEventListener('load', init);
</script>
</body>

</html>